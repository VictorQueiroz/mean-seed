"use strict";

var socket = io.connect();

angular.module("App", [ "ngRoute", "ngAnimate", "ngSanitize", "App/Routes", "App/Controllers", "App/Filters", "App/Directives", "App/Services", "partials", "Auth", "ui.bootstrap", "mgcrea.ngStrap" ]), 
angular.module("Auth/Service", [ "ngCookies", "Session" ]), angular.module("Auth/Directive/IfAuthenticated", [ "Session/Service" ]).directive("ifAuthenticated", [ "Session", function(Session) {
    return {
        link: function($scope, $element) {
            Session.isAuthenticated.then(function(res) {
                res.result || $element.remove();
            });
        }
    };
} ]), angular.module("Auth/Directive/IfGuest", [ "Session/Service" ]).directive("ifGuest", [ "Session", function(Session) {
    return {
        link: function($scope, $element) {
            Session.isAuthenticated.then(function(res) {
                res.result && $element.remove();
            });
        }
    };
} ]), angular.module("Auth/Directives", [ "Auth/Directive/IfAuthenticated", "Auth/Directive/IfGuest" ]), 
angular.module("Auth", [ "ngRoute", "Session/Service" ]).run([ "$rootScope", "$route", "$location", "Session", function($rootScope, $route, $location, Session) {
    $rootScope.$on("$routeChangeStart", function(event, next) {
        var params = next.$$route;
        console.log("Checking if you can access this location...");
        var isAuthenticated = Session.isAuthenticated;
        params.guest ? (console.log("This route are reserved for guests!"), console.log("Checking if you are a guest..."), 
        isAuthenticated.then(function(res) {
            res.result ? (console.log("You are not a guest."), console.log("You can not access this area."), 
            $location.path("/")) : res.result || console.log("You are a guest, you can go on!");
        })) : params.authenticated && (console.log("This route are reserved for authenticated users!"), 
        console.log("Checking if you are authenticated..."), isAuthenticated.then(function(res) {
            res.result ? res.result && console.log("You are authenticated, you can go on!") : (console.log("You are not authenticated."), 
            console.log("You can not access this area."), $location.path("/"));
        }));
    });
} ]), angular.module("Session/Service", [ "ngCookies" ]).factory("Session", [ "$http", "$cookieStore", function($http) {
    var res = $http.get("/auth/check");
    return {
        isAuthenticated: res.then(function(res) {
            return res.data.result ? {
                result: !0
            } : {
                result: !1
            };
        }),
        getUser: res.then(function(res) {
            return res.data.result ? res.data.user : {
                result: !1
            };
        })
    };
} ]), angular.module("Session", [ "Session/Service" ]), angular.module("User/Ctrl/Auth", [ "App/Services" ]).controller("AuthCtrl", [ "$scope", "$http", "$alert", "$socket", "$location", function($scope, $http, $alert, $socket, $location) {
    $socket.on("user authenticated", function(user) {
        alert("Congratulations, " + user.username + ", you're logged!");
    }), $socket.on("user unauthorized", function() {
        alert("Sorry, you can not access this area!");
    }), $socket.on("user authentication error", function() {
        alert("Ocorreu um erro, tente novamente mais tarde!");
    }), $scope.authenticate = function(credentials) {
        $http.post("/auth/local", credentials).then(function(res) {
            var user = res.data;
            res.data.result || $socket.emit("user unauthorized", {}), user.username ? ($socket.emit("user authenticated", user), 
            $location.path("/")) : $socket.emit("user authentication error", {});
        });
    };
} ]), angular.module("User/Ctrl/Profile", [ "Session/Service" ]).controller("ProfileCtrl", [ "$scope", "Session", function($scope, Session) {
    Session.getUser.then(function(user) {
        $scope.user = user;
    });
} ]), angular.module("User/Service", [ "ngResource" ]).factory("User", [ "$resource", function($resource) {
    return $resource("", {}, {
        get: {
            url: "/api/users/:id",
            params: {
                id: "@id"
            },
            method: "GET",
            isArray: !1
        },
        list: {
            url: "/api/users",
            params: {},
            method: "GET",
            isArray: !0
        },
        store: {
            url: "/api/users",
            params: {},
            method: "POST",
            isArray: !1
        },
        update: {
            url: "/api/users/:id",
            params: {
                id: "@id"
            },
            method: "PUT",
            isArray: !1
        },
        destroy: {
            url: "/api/users/:id",
            params: {
                id: "@id"
            },
            method: "DELETE",
            isArray: !1
        }
    });
} ]), angular.module("User/Ctrl/UserDetail", [ "ngRoute", "User/Service" ]).controller("UserDetailCtrl", [ "$scope", "$routeParams", "User", function($scope, $routeParams, User) {
    $scope.user = User.get({
        id: $routeParams.id
    });
} ]), angular.module("User/Ctrl/UserList", [ "User/Service" ]).controller("UserListCtrl", [ "$scope", "User", function($scope, User) {
    $scope.users = User.list();
} ]), angular.module("User/Controllers", [ "User/Ctrl/Auth", "User/Ctrl/Profile", "User/Ctrl/UserList", "User/Ctrl/UserDetail" ]), 
angular.module("User/Routes", [ "User/Controllers" ]).config([ "$routeProvider", function($routeProvider) {
    $routeProvider.when("/profile", {
        templateUrl: "users/profile.tpl.html",
        controller: "ProfileCtrl"
    });
} ]), angular.module("User/Services", [ "ngResource", "User/Service" ]), angular.module("App/Controllers", [ "User/Controllers" ]), 
angular.module("App/Directives", [ "Auth/Directives" ]), angular.module("App/Filters", []), 
angular.module("partials", []).run([ "$templateCache", function($templateCache) {
    $templateCache.put("about-us.tpl.html", "<div class=container><div class=row><div class=col-lg-12><h1>About us</h1><p>What don't you know about us? Feel free to e-mail me as a <b>friend</b>:</p><p>victorcqueirozg@gmail.com.</p></div></div></div>"), 
    $templateCache.put("authentication.tpl.html", '<div class=container><div class=row><div class=col-lg-12><h1>Autenticação</h1><form name=form ng-submit=authenticate(credentials)><div class=form-group><label for="">Nome de Usuário</label><input ng-model=credentials.username class=form-control></div><div class=form-group><label for="">Senha</label><input ng-model=credentials.password type=password class=form-control></div><div class=form-group><button type=submit class="btn btn-default">Conectar-se</button></div></form></div></div></div>'), 
    $templateCache.put("index.tpl.html", "<div class=container><div class=row><div class=col-lg-12><h1>You have arrived!</h1><p>Still waiting, soon we will have a good gruntfile for your development.</p></div></div></div>"), 
    $templateCache.put("users/list.tpl.html", '<div class=container><div class=row><div class=col-lg-12><table class=table><thead><th>Name</th><th>E-mail address</th><th>Username</th></thead><tbody ng-repeat="user in users"><tr><td><a href="/users/{{ user._id }}" ng-bind="(user.name || \'?\')"></a></td><td ng-bind=user.email></td><td ng-bind=user.username></td></tr></tbody></table></div></div></div>'), 
    $templateCache.put("users/profile.tpl.html", '<div class=container><div class=row><div class=col-md-12><img src=http://placehold.it/1600x500 width=100% alt="Profile photo"><h2>{{ user.name }} <small ng-bind=user.email></small></h2><p><b>Username:</b> {{ user.username }}</p></div></div></div>'), 
    $templateCache.put("users/show.tpl.html", '<div class=container><div class=row><div class=col-lg-12><img src=http://placehold.it/1600x500 width=100% alt="Profile photo"><h2>{{ user.name }} <small ng-bind=user.email></small></h2><p><b>Username:</b> {{ user.username }}</p></div></div></div>');
} ]), angular.module("App/Routes", [ "ngRoute", "User/Routes" ]).config([ "$routeProvider", "$locationProvider", function($routeProvider, $locationProvider) {
    $routeProvider.when("/", {
        templateUrl: "index.tpl.html"
    }).when("/about-us", {
        templateUrl: "about-us.tpl.html"
    }).when("/authentication", {
        templateUrl: "authentication.tpl.html",
        controller: "AuthCtrl",
        guest: !0
    }).otherwise({
        redirectTo: "/"
    }), $locationProvider.html5Mode(!0);
} ]), angular.module("App/Services", [ "User/Services" ]).value("version", "0.0.1").factory("$socket", [ "$window", function($window) {
    return $window.io();
} ]);